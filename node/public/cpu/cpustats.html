<! Sample dashboard for dtrace+ monitoring scripts for CPU >
<!  CREATED:	14 JUNE 2013 >
<!  MODIFIED:	18 JUNE 2013 >

<html>

<head>
<title>CPU Loads | Lucera</title>
<script src="./../socket.io/socket.io.js"></script>
<script type="text/javascript" src="./../d3/d3.v3.js"></script>
</head>

<body>

<a href="plist.html">Switch to per-process list</a><br>
<a href="tlist.html">Switch to per-thread list</a><br><br>

<script type="text/javascript">

/* Set up global containers / varibles */
var dataset = [];
var h = 214;
var textHeight = 14;
var w = 600;
var numberCores = 4;
var dataMax;
var interval = 1200; // in ms
var svg = d3.select("body")
			.append("svg")
			.attr("width", w)
			.attr("height", h);

/* Draw the chart every interval */
setInterval(function drawBarChart () {
	/* Remove all existing bars */
	svg.selectAll("rect").remove();
	svg.selectAll("text").remove();

	var usage = 0;

	/* Paint bars on the screen */
	for (var cpu=0; cpu<numberCores+1; cpu++) {

		svg.append("rect")
		   .attr("x", cpu*w/(numberCores+1))
		   .attr("y", textHeight)
		   .attr("width", w/(numberCores+1)-4)
		   .attr("height", h)
		   .attr("fill", "black");

		try {
			console.log(dataset[cpu]*h);
			svg.append("rect")
			   .attr("x", cpu*w/(numberCores+1)+1)
			   .attr("y", h-(dataset[cpu]*h)+textHeight)
			   .attr("width", w/(numberCores+1)-5)
			   .attr("height", dataset[cpu]*h)
			   .attr("fill", "rgba(25,10,200,1.0)");
			usage = Math.floor(dataset[cpu]*1000)/10;
		} catch (err) {
			/* We can't draw because data wasn't reported */
		}

		svg.append("text")
		   .text( function() {
				if (cpu==numberCores) return ("AVG: " + usage + "%");
				return ("CPU" + cpu + ": " + usage + "%");
			})
		   .attr("x", cpu*(w/(numberCores+1))+w/(numberCores+1)/2)
		   .attr("y", textHeight - 4)
		   .attr("font-family", "sans-serif")
		   .attr("font-size", "12px")
		   .attr("fill", "black")
		   .attr("text-anchor", "middle");
	}

	}, interval);

/* Server IO */
var socket = new io.connect();
socket.on('connect', function(){ 
	console.log(' > connected');
	socket.emit('message', {'type' : 'loaddist'});
});

socket.on('message', function(message){ 
	dataset = {};
	var sum = 0;

	for (var cpu=0; cpu<numberCores; cpu++) {
		dataset[cpu] = 0;
		try {
			dataset[cpu] = message[cpu]/message['nfo'];
			if (dataset[cpu] > 1) dataset[cpu] = 1;
			sum += dataset[cpu];
		} catch (err) {
			console.log(err);
		}
	}
	dataset[numberCores] = sum/numberCores;
}); 
</script>

</body>
</html>