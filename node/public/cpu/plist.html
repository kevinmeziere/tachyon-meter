<!. Sample dashboard for dtrace process monitoring scripts      .>
<!.    Displays all running processes and their core usage      .>
<!.    as it is distributed from one core to the next           .>
<!.                                                             .>
<!. CREATED:   14 JUNE 2013                                     .>
<!. MODIFIED:  27 JUNE 2013                                     .>

<html>

<head>
<title>Process List | Lucera</title>
<script src="./../socket.io/socket.io.js"></script>
<script src="./../depends/d3.v3.js"></script>
</head>

<body>

<a href="cpustats.html">Switch to overview</a><br>
<a href="tlist.html">Switch to per-thread list</a><br><br>

<input type="button" value="per process" onclick="changeScale(1);" /><br>
<input type="button" value="total" onclick="changeScale(0);" /><br>

FONT SIZE&nbsp;&nbsp;
<input type="button" value="-" onclick="fontChange(-1);" />
<input type="button" value="+" onclick="fontChange(1);" />
<br>

<script type="text/javascript">
var dataset = {};

/* Constants etc. */
var colors = ["orange", "red", "green", "blue", "coral", "cyan", "deeppink",
                "aquamarine", "gray", "lawngreen", "lightpink", "yellow",
                "steelblue", "teal", "tan", "seagreen"];
var bgColor = "rgba(25, 25, 25, 0.8)";
var numberCores = 16;
var interval = 1200;
var textHeight = 15;
var scalingMode = 1;
var rate = 4999;
var h = 2014;
var w = 700;

/* Set up global container */
var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);

/* Aesthetics */
function changeScale(mode) {
  scalingMode = mode;
}
function fontChange(delta) {
  textHeight += delta;
}

/* Drawing loop */
setInterval(function drawPList () {
  svg.selectAll("rect").remove();
  svg.selectAll("text").remove();

  for (var proc=0; proc<numberCores; proc++) {
    svg.append("rect")
       .attr("x", proc*(w/numberCores))
       .attr("y", 0)
       .attr("width", (w/numberCores)-2)
       .attr("height", textHeight)
       .attr("fill", colors[proc]);

    svg.append("text")
       .attr("x", (proc+.5)*(w/numberCores)-1)
       .attr("y", textHeight-5)
       .text("CPU " + proc)
       .attr("font-family", "sans-serif")
       .attr("font-size", (textHeight-8)+"px")
       .attr("fill", "white")
       .attr("text-anchor", "middle");
  }

  var idx = 0;
  
  for (var proc in dataset) {
    if (!dataset[proc][2]) {
    continue;
    }

    idx = idx+1;

    svg.append("rect")
       .attr("x", 0)
       .attr("y", idx*(textHeight+2))
       .attr("width", 300)
       .attr("height", textHeight)
       .attr("fill", bgColor);

    svg.append("rect")
       .attr("x", 300)
       .attr("y", idx*(textHeight+2))
       .attr("width", w-300)
       .attr("height", textHeight)
       .attr("fill", "black");

    var position = 300;
    
    for (var core=0; core<numberCores; core++) {
      if (dataset[proc][core+3]) {
        if (scalingMode==1) var thisWidth = dataset[proc][core+3]/dataset[proc][2];
        else if (scalingMode==0) var thisWidth = dataset[proc][core+3]/rate/numberCores;
        
        thisWidth = thisWidth*(w-300);

        svg.append("rect")
           .attr("x", position)
           .attr("y", idx*(textHeight+2))
           .attr("width", thisWidth)
           .attr("height", textHeight)
           .attr("fill", colors[core]);   
    
        position = position + thisWidth;
      }
    }

    svg.append("text")
       .text(dataset[proc][0])
       .attr("x", 10)
       .attr("y", (idx+1)*(textHeight+2)-7)
       .attr("font-family", "sans-serif")
       .attr("font-size", (textHeight-8)+"px")
       .attr("fill", "white")
       .attr("text-anchor", "start");

    svg.append("text")
       .text(dataset[proc][1])
       .attr("x", 80)
       .attr("y", (idx+1)*(textHeight+2)-7)
       .attr("font-family", "sans-serif")
       .attr("font-size", (textHeight-8)+"px")
       .attr("fill", "white")
       .attr("text-anchor", "start");

    svg.append("text")
       .text(Math.floor(dataset[proc][2]/rate/numberCores*1000)/10 + "%")
       .attr("x", 280-textHeight)
       .attr("y", (idx+1)*(textHeight+2)-7)
       .attr("font-family", "sans-serif")
       .attr("font-size", (textHeight-8)+"px")
       .attr("fill", "white")
       .attr("text-anchor", "start");
  }
}, interval);

/* Server IO */
var socket = new io.connect();

socket.on('connect', function(){ 
  console.log(' > connected');
  socket.emit('message', {'type' : 'percpu'});
});

socket.on('message', function(message){ 
  dataset = {}; /* Clear dataset to refresh information */
  
  for (var proc in message) {
    var itms = proc.split(',');
    try {

      if (!(dataset[itms[0]])) {
        dataset[itms[0]] = [];
        dataset[itms[0]][0] = parseInt(itms[0]);
        dataset[itms[0]][1] = itms[1];
      }

      var idx = 3+parseInt(itms[2]);

      if (idx) dataset[itms[0]][idx] = message[proc];
      
    } catch (err) {
      console.log(err);
    }
  }

  for (var proc in dataset) {
    var sum = 0;
    for (var k=0; k<numberCores; k++) {
      if(dataset[proc][k+3]) sum = sum + dataset[proc][k+3];
    }
    dataset[proc][2] = sum;
  }

});
</script>

</body>
</html>