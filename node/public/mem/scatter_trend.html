<!.  Sample dashboard for dtrace process monitoring scripts      .>
<!.    Shows time-wise distribution of either process or        .>
<!.    generalized malloc or brk (respectively) calls.          .>
<!.                                                             .>
<!. CREATED:   21 JUNE 2013                                     .>
<!. MODIFIED:   2 JULY 2013                                     .>

<html>

<head>
<title>mmap statistics | Lucera</title>
<script src="./../socket.io/socket.io.js"></script>
<script src="./../depends/d3.v3.js"></script>
</head>

<body>

<script type="text/javascript">

/* Set up global containers / varibles */

var dataset = [];
var countset =[];
var h = 300;
var textHeight = 14;
var w = 600;
var numberMemory = 3;
var dataMax;
var minSpeed = 60;
var interval = 1200; // in ms
var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);
var rad = 2;

/* Print Text */
function printa(te, x, y,  size)
{
svg.append("text")
   .text(te)
   .attr("x" , x)
   .attr("y" , y)
   .attr("font-family", "sans-serif")
   .attr("font-size", size)
   .attr("fill", "black")
   .attr("text-anchor", "start");
  return; 
}


/* Set Up Grid with labels*/
setInterval(function drawPList () {
  svg.selectAll("circle").remove();
  svg.selectAll("text").remove();
  svg.selectAll("line").remove();

  /*Insert different grid markers */

  var xpos = [68.84, 108.71, 148.57, 188.4, 228.3];

  for (var xp in xpos) {
    printa("|", xpos[xp], 160, 15);
  }

  printa("100", 64.84, 170 , 10);
  printa("1000", 108.71, 170 , 10);
  printa("10000", 148.57, 170 , 10);
  printa("100000", 188.4, 170 , 10);
  printa("1000000", 228.3, 170 , 10);
  printa("Memory Allocation Time Counts (ns)", 220, 95, 15);
  printa("Rolling Average Memory Allocation Time Counts (ns)", 220 ,15, 15);
  printa("Counts", 80, 178, 7);
  printa("100 –", 50, 130, 10);
  printa("100 –" , 50, 71.67, 10);

  svg.append("rect")
     .attr("x", 60)
     .attr("y", 142)
     .attr("width", 540 )
     .attr("height", 5)
     .attr("fill", "blue");

  /* Prints counts for each datapoint */
  try {
    var start = 185;
    for(var id in countset) {
      printa(id, 60, start, 5);
      printa(countset[id] , 80, start, 5);
      start += 5;
    }
  } catch(err) {}

  /*Draws Circles*/
  for (var time in dataset) {
    svg.append("circle")
       .attr("cx",12* Math.log(time/minSpeed)/Math. log(2) + 60)
       .attr("cy", 140 - dataset[time][0]/10)
       .attr("r", rad);
  }

  /*Draws the Graph */
  var last = 0;
  for (var x = 1; x <=  540; x++) {
    var count = 0
    /* Finds how many other counts are near it */
    for (var time in dataset) {
      if (Math.abs (12* Math.log(time/minSpeed)/Math. log(2) - x)  < 2) {
        count += dataset[time][0]
      }
    }

    svg.append("line")
       .attr("x1", x-1 + 60)
       .attr("y1", 80 - last/12)
       .attr("x2", x + 60)
       .attr("y2", 80 -  count / 12)
       .attr("stroke-width", 2)
       .attr("stroke", "black")
    last = count;
  }
});

/* Server IO */
var socket = new io.connect();

socket.on('connect', function(){
  console.log(' > connected');
  if(location['search'].length > 1) {
    socket.emit('message' , {'type' : 'malloc_count',
    'command': location['search'].substring(1)});
  } else {
    socket.emit('message', {'type' : 'brk_count'});
  }
});

socket.on('message', function(message) {
  dataset = {};
  countset = {};

  for (var id in message) {
    if (id == 'type') continue;
    if (id == 'cpu') continue;
    if (id == 'mem') continue;

    var idents = id.split(',');
    dataset[idents[1]] = [message[id], idents[0]];
    var f = idents[0]

    /* Initiallizes point for zero */

    if (isNaN(countset[f]))
      countset[f] = 0;

    countset[f]++;
  }
});
</script>

<br><br>

<a href="./memstats.html">Overview utilization of memory</a><br>
<a href="./vminfo.html">Paging syscall occurrence</a><br>


</body>
</html>
