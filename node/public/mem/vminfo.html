<!. Sample dashboard for dtrace process monitoring scripts      .>
<!.    Information about paging system calls                    .>
<!.                                                             .>
<!. CREATED:   21 JUNE 2013                                     .>
<!. MODIFIED:   3 JULY 2013                                     .>

<html>

<head>
<title>vminfo | Lucera</title>
<script src="./../socket.io/socket.io.js"></script>
<script src="./../depends/d3.v3.js"></script>
</head>

<body>

<script type="text/javascript">
/* Set up global containers / varibles */
var svg = d3.select("body")
            .append("svg")
            .attr("width", w)
            .attr("height", h);
var dataset = [];
var countSet =[];

var numberMemory = 3;
var textHeight = 14;
var interval = 1200;
var minSpeed = 60;
var rad = 2;
var h = 300;
var w = 800;
var dataMax;

/* List of Paging Types */
var database =
  new Array("anonfree","anonpgin", "anonpgout", "as_fault", "cow_fault", "dfree", "execfree",
              "execpgin", "execpgout", "fsfree", "fspgin", "fspgout", "kernel_asflt",
              "maj_fault", "pgpin", "pgpout", "pgfrec", "pgrec", "pgrrun", "pgswapin",
              "pgswapout", "prot_fault", "softlock", "swapin", "swapout", "zfod");

/* Paging Abbreviations for display */
var ref  = 
  new Array("apf", "api", "apo", "as", "cow", "dfr", "epf", "epi", "epo", "fpf", "fpi", "fpo",
              "kaf", "mf", "pgpi", "pgpo", "pgfr", "pgre", "pgrr", "pgsi", "pgso", "prot",
              "sloc", "swi", "swo", "zfod");

/* One color for each paging type */
var colors =
  new Array("orange", "red", "green", "purple", "blue", "coral", "cyan", "deeppink", "aquamarine",
    "darkcyan", "lawngreen", "lightpink", "sienna", "steelblue", "teal", "tan", "seagreen", "crimson",
    "darkgreen", "darkmagenta", "darksalmon", "thistle" , "fuchsia", "gold" , "olive", "palegreen");

var bgColor = "rgba(25, 25, 25, 0.8)";

/* Set Up Grid with labels*/
setInterval(function drawPlot() {
  svg.selectAll("rect").remove();
  svg.selectAll("text").remove();

  /* Create Rectangles showing abbreviation with color */
  for (var proc=0; proc< database.length; proc++) {
    svg.append("rect")
       .attr("x", proc*(w/database.length))
       .attr("y", 0)
       .attr("width", (w/database.length)-2)
       .attr("height", textHeight)
       .attr("fill", colors[proc]);

    svg.append("text")
       .text(ref[proc])
       .attr("x", (proc+.5)*(w/database.length)-1)
       .attr("y", textHeight-5)
       .attr("font-family", "sans-serif")
       .attr("font-size", (textHeight-8)+"px")
       .attr("fill", "white")
       .attr("text-anchor", "middle");
  }

  try {
    var idx = 0;

    /* Creates the rectangles that show the data */
    for (var proc in countset) {
      idx = idx + 1

      /* Create the two rectangles were the other information goes */
      svg.append("rect")
         .attr("x", 0)
         .attr("y", idx*(textHeight+2))
         .attr("width", 200)
         .attr("height", textHeight)
         .attr("fill", bgColor);

      svg.append("rect")
         .attr("x", 200)
         .attr("y", idx*(textHeight+2))
         .attr("width", w-200)
         .attr("height", textHeight)
         .attr("fill", "black");

      var position = 200;
      /* Create the smaller rectangles of color matching type */
      for(var other in dataset) {
        another = other % 100000;

        if(proc == another) {
          var thisWidth = (w-200) * dataset[other][0] / countset[proc];

          svg.append("rect")
             .attr("x", position)
             .attr("y", idx*(textHeight+2))
             .attr("width", thisWidth)
             .attr("height", textHeight)
             .attr("fill", colors[Math.floor(other/100000)]);

          svg.append("text")
             .text( dataset[other][0]) 
             .attr("x", position + thisWidth/8)
             .attr("y", (idx+1)*(textHeight+2)-7)
             .attr("font-family", "sans-serif")
             .attr("font-size", (textHeight-8)+"px")
             .attr("font-weight", "bold")
             .attr("fill", "white")
             .attr("text-anchor", "start");

          position = position + thisWidth;
        }
      }

      /* Print the PID and total counts */
      svg.append("text")
         .text("Pid:    " + proc)
         .attr("x", 10)
         .attr("y", (idx+1)*(textHeight+2)-7)
         .attr("font-family", "sans-serif")
         .attr("font-size", (textHeight-8)+"px")
         .attr("fill", "white")
         .attr("text-anchor", "start");

      svg.append("text")
         .text("Total Count:   " + countset[proc])
         .attr("x", 100)
         .attr("y", (idx+1)*(textHeight+2)-7)
         .attr("font-family", "sans-serif")
         .attr("font-size", (textHeight-8)+"px")
         .attr("fill", "white")
         .attr("text-anchor", "start");
    }
  } catch(err) {}
});

/* Server IO */
var socket = new io.connect();

socket.on('connect', function(){ 
  console.log(' > connected');
  socket.emit('message', {'type' : 'vminfo'});
});

socket.on('message', function(message){ 
  dataset = {};
  countset = {};

  for (var id in message) {
    /* Filter Other Messages */
    if (id == 'type') continue;
    if (id == 'cpu') continue;
    if (id == 'mem') continue;

    var info = 0;

    /* Split the Array into readable parts */
    var idents = id.split(',');   

    /* Find out the type of page in */           
    for (var f = 0; f < database.length; f++) {
      if (database[f] == (idents[2])) {
        info = f;
      }
    }

    /* Create a new ID number for easy storage */      
    info = info*100000 + parseInt(idents[0]);
    love = parseInt(idents[0]);

    if (isNaN(countset[love])) {
      countset[love] = 0;
    }
    /* Stores the count based on the general ID */
    countset[love]  += message[id];
    /* Stores the count based on specific ID */
    dataset[info] = [message[id]];
  }
}); 
</script>

<br><br>
<a href="./memstats.html">Overview utilization of memory</a><br>
<a href="./scatter_trend.html">Memory calls</a><br>
<br><br>

</body>
</html>